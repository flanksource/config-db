---
apiVersion: configs.flanksource.com/v1
kind: ScrapeConfig
metadata:
  name: slack-flanksource
  namespace: default
spec:
  schedule: '@every 5h'
  slack:
    - channels:
        - 'notification-*'
      since: 7d
      token:
        valueFrom:
          secretKeyRef:
            name: slack-mission-control-bot
            key: token
      rules:
        - regexp: name:\s*(?<name>.*?)\s+type:\s*(?<change_type>.*?)\s+is\s+.*\nseverity:\s*(?<severity>\w+)
          filter:
            bot: 'Notifier'
            expr: text.contains('healthy') # match healthy/unhealthy
          config:
            - name:
                expr: env.?name.orValue('')
              type:
                expr: env.?change_type.orValue('')
          mapping:
            type:
              value: health
            timeFormat: '02 Jan 06 15:04 MST'
            createdAt:
              value: 13 Jul 24 15:04 MST
            severity:
              expr: env.?severity.orValue('')
            summary:
              expr: text.substring(25)
